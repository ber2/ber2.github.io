<!doctype html>
<html lang="en-us">
  <head>
    <title>Hashing documents during the Cookiepocalypse // Alberto Cámara</title>
    <link rel="shortcut icon" href="/images/pingu.jpg" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.146.7">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Alberto Cámara" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css" />
    

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hashing documents during the Cookiepocalypse">
  <meta name="twitter:description" content="The FLoC proposal As part of their phasing-out of third party cookies and rolling out of the Privacy Sandbox, Google have announced their intentions to replace third party cookies in Chrome. The strategy is to replace each of the functions served by third party cookies in web advertising, one by one, by individual devices that preserve user privacy.
Federated Learning of Cohorts (FLoC) is the replacement for cross-site user tracking on Google Chrome. In order to enable targeting based on browsing interests without cookie identifiers, the user’s browser computes a cohort identifier, that is: a hash of the browsing history.">

    <meta property="og:url" content="https://ber2.github.io/posts/simhash/">
  <meta property="og:site_name" content="Alberto Cámara">
  <meta property="og:title" content="Hashing documents during the Cookiepocalypse">
  <meta property="og:description" content="The FLoC proposal As part of their phasing-out of third party cookies and rolling out of the Privacy Sandbox, Google have announced their intentions to replace third party cookies in Chrome. The strategy is to replace each of the functions served by third party cookies in web advertising, one by one, by individual devices that preserve user privacy.
Federated Learning of Cohorts (FLoC) is the replacement for cross-site user tracking on Google Chrome. In order to enable targeting based on browsing interests without cookie identifiers, the user’s browser computes a cohort identifier, that is: a hash of the browsing history.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-03-10T00:00:00+00:00">
    <meta property="article:tag" content="Simhash">
    <meta property="article:tag" content="Third-Party Cookies">
    <meta property="article:tag" content="Online Advertising">
    <meta property="article:tag" content="Hashing">


  </head>
  <body>
    <header class="app-header">
      <a href="/"><img class="app-header-avatar" src="/images/pic.jpeg" alt="Alberto Cámara" /></a>
      <span class="app-header-title">Alberto Cámara</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/cv">CV</a>
             - 
          
          <a class="app-header-menu-item" href="/posts">Posts</a>
             - 
          
          <a class="app-header-menu-item" href="/talks">Talks</a>
             - 
          
          <a class="app-header-menu-item" href="/contact">Contact</a>
             - 
          
          <a class="app-header-menu-item" href="/tags">Tags</a>
      </nav>
      <p>Freelance Data Scientist</p>
      <div class="app-header-social">
        
          <a href="https://github.com/ber2" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-github" viewBox="0 0 24 24" fill="currentColor"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          </a>
        
          <a href="https://www.linkedin.com/in/alberto-camara/" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-linkedin" viewBox="0 0 24 24" fill="currentColor"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Hashing documents during the Cookiepocalypse</h1>
      <div class="post-meta">
        <div>
          <svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Mar 10, 2021
        </div>
        <div>
          <svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          3 min read
        </div>
        <div>
          <svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
              <a class="tag" href="/tags/simhash/">Simhash</a>
              <a class="tag" href="/tags/third-party-cookies/">Third-Party Cookies</a>
              <a class="tag" href="/tags/online-advertising/">Online Advertising</a>
              <a class="tag" href="/tags/hashing/">Hashing</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h2 id="the-floc-proposal">The FLoC proposal</h2>
<p>As part of their phasing-out of third party cookies and rolling out of the <a href="https://blog.google/products/ads-commerce/2021-01-privacy-sandbox/">Privacy Sandbox</a>, Google have announced their intentions to replace third party cookies in Chrome.
The strategy is to replace each of the functions served by third party cookies in web advertising, one by one, by individual devices that preserve user privacy.</p>
<p><a href="https://github.com/WICG/floc">Federated Learning of Cohorts</a> (<strong>FLoC</strong>) is the replacement for cross-site user tracking on Google Chrome.
In order to enable targeting based on browsing interests without cookie identifiers, the user&rsquo;s browser computes a <strong>cohort identifier</strong>, that is: a hash of the browsing history.</p>
<p>We expect the following to happen:</p>
<ul>
<li>
<p>Users with similar browsing behaviours end up having the same hash, so it is still possible to show relevant ads by targeting a given cohort id.</p>
</li>
<li>
<p>Cohorts contain enough users to allow a <em>hiding in the pack</em> effect, where an individual&rsquo;s activity is not distinguishable.</p>
</li>
</ul>
<h2 id="enter-locality-sensitive-hashing-techniques">Enter locality-sensitive hashing techniques</h2>
<p>The candidate algorithm to achieve the above goal is <a href="https://en.wikipedia.org/wiki/SimHash">SimHash</a>, which is commonly used to detect near-duplicates by search engines.
After vectorizing a user&rsquo;s browsing history, the <code>p</code>-bit <code>SimHash</code> algorithm works in the following way:</p>
<ul>
<li>
<p>Choose <code>p</code> random unit vectors in feature space. These determine <code>p</code> hyperplanes passing through origin, by relating each hyperplane to its normal vector.</p>
</li>
<li>
<p>These <code>p</code> hyperplanes determine a partition of space into <code>2^p</code> regions.</p>
</li>
<li>
<p>Encode each of the above regions as an integer in base <code>2</code> (ie: pick an ordering of the <code>p</code> unit vectors).</p>
</li>
<li>
<p>The hash of a vector (ie: a user&rsquo;s browsing history) is determined by the region to which it belongs.</p>
</li>
</ul>
<h2 id="an-implementation-in-python">An implementation in Python</h2>
<p>When we set out to study the impact of replacing cookies by cohorts in our Machine Learning pipelines at <a href="https://hybridtheory.com/">Hybrid Theory</a>, I was unable to find an implementation of the SimHash algorithm in pure Python that served the purposes.
So we coded and open-sourced one, and published it as a python package under the name of <a href="https://pypi.org/project/floc-simhash/"><strong>floc-simhash</strong></a>.</p>
<p>This implementation has allowed us to conduct preliminary analysis on our own datasets, while we wait for Google&rsquo;s Origin Trial to begin later in this month of March, 2021.</p>
<p>While waiting for details regarding the final form of the FLoC implementation, we have provided two implementations of SimHash:</p>
<ul>
<li>
<p>One based directly on bitwise arithmetic of <strong>md5 hashes</strong> of individual tokens, aimed at hashing any given text document.</p>
</li>
<li>
<p>One designed as a <strong>scikit-learn pipeline</strong>, that works on a document vectorization such as <strong>OneHot</strong> or <strong>TfIdf</strong>, taking advantage of the vectorization power of numpy arrays and scipy sparse matrices.</p>
</li>
</ul>
<p>For more details and examples, please refer to the <a href="https://github.com/hybridtheory/floc-simhash">README</a>.</p>
<h2 id="open-questions">Open questions</h2>
<p>While we wait for implementation details, the most recent news point towards:</p>
<ul>
<li>
<p>A hashing algorithm combining <code>SimHash</code> with the so-called <code>SortingLHS</code> technique, which consists of cropping the number of bits in the hash in order to have less cohorts. The resulting hashes lie around <code>50</code>-bit precision.</p>
</li>
<li>
<p>User browsing history to be constrained to the previous seven days.</p>
</li>
<li>
<p>An implementation of FLoC which will be computed directly on the user&rsquo;s browser.
Thus, browsing history need not be shared with a central API for the purposes of computing cohort ids.</p>
</li>
</ul>
<p>These, however, will be subject to change depending on the Origin Trial results.</p>
<p>More generally, the question regarding the eventual adoption of FLoC remains.</p>
<p>In the next few months, we aim at deciding whether the cookiepocalypse results in having to re-think the whole approach to selling ads online or, as claimed in the <a href="https://raw.githubusercontent.com/google/ads-privacy/master/proposals/FLoC/FLOC-Whitepaper-Google.pdf">original proposal</a>, FLoCs are performant enough to allow for the cross-targeting approach to survive on Google Chrome.</p>
<h2 id="references">References</h2>
<ul>
<li>
<p><a href="https://github.com/hybridtheory/floc-simhash">GitHub repository</a>, containing installation instructions and examples.</p>
</li>
<li>
<p><a href="https://pypi.org/project/floc-simhash/">PyPI package</a>. Please install by calling <code>pip install</code>.</p>
</li>
<li>
<p><a href="https://engineering.hybridtheory.com/engineering/open-source/python/2021/03/09/floc-simhash-opensource/">Post</a> in our engineering blog at Hybrid Theory.</p>
</li>
<li>
<p><a href="https://www.linkedin.com/posts/hybridtheory_investigating-googles-floc-open-sourcing-activity-6775098443296718848-YngA">Company announcement</a> at LinkedIn.</p>
</li>
<li>
<p>The repository for the <a href="https://github.com/WICG/floc">FLoC</a> proposal at GitHub.</p>
</li>
<li>
<p>The proposal <a href="https://raw.githubusercontent.com/google/ads-privacy/master/proposals/FLoC/FLOC-Whitepaper-Google.pdf">whitepaper</a>.</p>
</li>
</ul>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
